#!/bin/bash
# ═══════════════════════════════════════════════════════════
#  AtherixCloud Tunnel v4.0 (Auto fallback random port)
# ═══════════════════════════════════════════════════════════

SERVER="45.10.165.199"
USER="tunnel"
SSH_PORT=22

CONFIG_DIR="$HOME/.atherix-tunnel"
KEY_FILE="$CONFIG_DIR/.key"
LOG_DIR="$CONFIG_DIR/logs"
PID_DIR="$CONFIG_DIR/pids"

mkdir -p "$CONFIG_DIR" "$LOG_DIR" "$PID_DIR"
chmod 700 "$CONFIG_DIR"

RED="\e[31m"; GRN="\e[32m"; YEL="\e[33m"; CYN="\e[36m"; RST="\e[0m"

# ═══════════════════════════════════════════════════════════
# SSH KEY
# ═══════════════════════════════════════════════════════════
setup_key(){
if [ ! -f "$KEY_FILE" ];then
cat>"$KEY_FILE"<<'KEY'
-----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gtZW
QyNTUxOQAAACBJEK7mHycRjc8BFmcqL7PjJFgcDaRhFaDPinB8fjS54wAAAJhiOSxDYjks
QwAAAAtzc2gtZWQyNTUxOQAAACBJEK7mHycRjc8BFmcqL7PjJFgcDaRhFaDPinB8fjS54w
AAAEAy5wkmy3eoL+/RPuv+kv0s473dRWyOCFmvTBUCLPn89EkQruYfJxGNzwEWZyovs+Mk
WBwNpGEVoM+KcHx+NLnjAAAAFXR1bm5lbC1yZXN0cmljdGVkLWtleQ==
-----END OPENSSH PRIVATE KEY-----
KEY
chmod 600 "$KEY_FILE"
fi
}

# ═══════════════════════════════════════════════════════════
# CHECK PORT ON SERVER
# ═══════════════════════════════════════════════════════════
check_remote_port(){
local port="$1"

ssh -i "$KEY_FILE" \
-o StrictHostKeyChecking=no \
-o UserKnownHostsFile=/dev/null \
-p $SSH_PORT \
$USER@$SERVER "ss -tuln | grep -q :$port" >/dev/null 2>&1
return $?
}

# ═══════════════════════════════════════════════════════════
# START
# ═══════════════════════════════════════════════════════════
start_tunnel(){
local port="$1"
local pid_file="$PID_DIR/tunnel-$port.pid"
local map_file="$CONFIG_DIR/.port-$port"
local log_file="$LOG_DIR/tunnel-$port.log"

if [ "$port" -lt 1 ] || [ "$port" -gt 65535 ];then
echo -e "${RED}Invalid port${RST}"
return 1
fi

setup_key

echo -e "${CYN}Checking port...${RST}"

# Проверка
check_remote_port "$port"
if [ $? -eq 0 ]; then
echo -e "${YEL}Port $port busy → using random free port${RST}"
REMOTE="0:localhost:$port"
else
REMOTE="$port:localhost:$port"
fi

echo -e "${GRN}Starting tunnel...${RST}"

ssh -i "$KEY_FILE" \
-o StrictHostKeyChecking=no \
-o UserKnownHostsFile=/dev/null \
-o ExitOnForwardFailure=yes \
-o ServerAliveInterval=30 \
-o ServerAliveCountMax=3 \
-o ConnectTimeout=10 \
-N -f \
-R $REMOTE \
$USER@$SERVER \
-p $SSH_PORT \
>"$log_file" 2>&1

sleep 3

# Получаем внешний порт
if grep -q "Allocated port" "$log_file"; then
remote_port=$(grep "Allocated port" "$log_file" | grep -oE '[0-9]{4,5}' | head -1)
else
remote_port="$port"
fi

ssh_pid=$(pgrep -f "ssh.*$SERVER.*$port" | head -1)

if [ -n "$ssh_pid" ];then
echo "$ssh_pid" > "$pid_file"
echo "$remote_port" > "$map_file"

echo
echo -e "${GRN}✓ Tunnel active${RST}"
echo "Local: localhost:$port"
echo "Public: http://$SERVER:$remote_port"
else
echo -e "${RED}Failed${RST}"
echo "Log: $log_file"
fi
}

# ═══════════════════════════════════════════════════════════
# STOP
# ═══════════════════════════════════════════════════════════
stop_tunnel(){
kill "$(cat "$PID_DIR/tunnel-$1.pid" 2>/dev/null)" 2>/dev/null
rm -f "$PID_DIR/tunnel-$1.pid"
echo "Stopped"
}

# ═══════════════════════════════════════════════════════════
# LIST
# ═══════════════════════════════════════════════════════════
list_tunnels(){
for f in "$PID_DIR"/tunnel-*.pid;do
[ -f "$f" ] || continue
port=$(basename "$f" .pid | sed 's/tunnel-//')
echo "Port $port → http://$SERVER:$(cat "$CONFIG_DIR/.port-$port")"
done
}

# ═══════════════════════════════════════════════════════════
# MAIN
# ═══════════════════════════════════════════════════════════
case "$1" in
[0-9]*)
start_tunnel "$1"
;;
stop)
stop_tunnel "$2"
;;
list)
list_tunnels
;;
*)
echo "Usage:"
echo "tunnel <port>"
echo "tunnel stop <port>"
echo "tunnel list"
;;
esac
